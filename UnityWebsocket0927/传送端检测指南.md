# 传送端检测指南

## 🎯 问题诊断

当前Unity端显示灰色画面，尺寸为1280x400，说明**传送端（Web端）的Canvas或getDisplayMedia设置有问题**。

## 🔍 传送端需要检查的地方

### 1. getDisplayMedia 设置

确保使用正确的视频约束：

```javascript
// ✅ 正确设置
const stream = await navigator.mediaDevices.getDisplayMedia({
  video: {
    width: { ideal: 1280 },
    height: { ideal: 720 },
    frameRate: { ideal: 30, max: 30 }
  }
});

// 检查实际设置
console.log('传送端视频设置:', stream.getVideoTracks()[0].getSettings());
// 应该输出: { width: 1280, height: 720, ... }
```

### 2. Canvas 设置

如果使用Canvas绘制再传输：

```javascript
// ✅ 正确设置Canvas尺寸
const canvas = document.getElementById('myCanvas');
canvas.width = 1280;   // 不是CSS width
canvas.height = 720;   // 不是CSS height

// 确保视频元素尺寸匹配
const video = document.getElementById('myVideo');
video.width = canvas.width;
video.height = canvas.height;

// 绘制时使用正确尺寸
ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
```

### 3. WebRTC 传输设置

```javascript
// 确保使用正确的stream
const stream = await navigator.mediaDevices.getDisplayMedia({...});
peerConnection.addTrack(stream.getVideoTracks()[0], stream);

// ❌ 不要使用getUserMedia（摄像头）
// const cameraStream = await navigator.mediaDevices.getUserMedia({...});
```

## 🔧 Unity端调试功能

Unity端已添加以下调试功能：

1. **自动保存第一帧**：`debug_frame.png` 文件会保存到项目根目录
2. **尺寸检测**：如果收到1280x400，会显示错误信息
3. **比例控制**：自动添加AspectRatioFitter避免画面压扁

## 📋 检查清单

- [ ] 传送端使用 `getDisplayMedia` 而不是 `getUserMedia`
- [ ] Canvas的 `width` 和 `height` 属性设置为1280x720
- [ ] 没有使用CSS设置Canvas尺寸
- [ ] 检查浏览器控制台是否有错误
- [ ] 确认选择的是正确的屏幕/窗口进行分享

## 🚨 常见错误

1. **Canvas高度400px**：CSS设置了 `height: 400px`，但Canvas属性应该是720
2. **选择错误窗口**：浏览器弹出选择时选择了空白窗口
3. **使用摄像头**：错误使用了 `getUserMedia` 而不是 `getDisplayMedia`

## 📞 下一步

1. 运行Unity项目，查看Console日志
2. 检查项目根目录的 `debug_frame.png` 文件
3. 根据错误信息修改传送端代码
4. 重新测试连接

如果问题仍然存在，请提供传送端的WebRTC相关代码进行进一步诊断。
