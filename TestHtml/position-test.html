<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>AR.js ä½ç§»æµ‹è¯• - Marker è¿½è¸ª</title>
    
    <!-- A-Frame æ ¸å¿ƒåº“ -->
    <script src="https://cdn.jsdelivr.net/npm/aframe@1.4.2/dist/aframe.min.js"></script>
    <!-- AR.js A-Frame é›†æˆ (Marker è¿½è¸ªç‰ˆæœ¬) -->
    <script src="https://cdn.jsdelivr.net/npm/ar.js@3.4.0/build/aframe-ar.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            overflow: hidden;
            background: #000;
        }
        
        /* AR åœºæ™¯å®¹å™¨ */
        #ar-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1;
        }
        
        /* çŠ¶æ€æ  */
        .status-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 10px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #fff;
            font-size: 14px;
        }
        
        .status-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-indicator.connected {
            background: #4CAF50;
            box-shadow: 0 0 10px #4CAF50;
        }
        
        .status-indicator.tracking {
            background: #2196F3;
            box-shadow: 0 0 10px #2196F3;
        }
        
        .status-indicator.error {
            background: #f44336;
            box-shadow: 0 0 10px #f44336;
        }
        
        /* æ•°æ®é¢æ¿ */
        .data-panel {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            padding: 15px;
            max-height: 50vh;
            overflow-y: auto;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.5);
        }
        
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .data-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .data-card h4 {
            color: #FFD700;
            font-size: 12px;
            margin-bottom: 8px;
            text-transform: uppercase;
        }
        
        .data-value {
            color: #fff;
            font-size: 18px;
            font-weight: bold;
            font-family: 'Courier New', monospace;
        }
        
        .data-unit {
            color: rgba(255, 255, 255, 0.6);
            font-size: 10px;
            margin-top: 4px;
        }
        
        /* æ§åˆ¶é¢æ¿ */
        .control-panel {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            color: #fff;
            cursor: pointer;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 15px rgba(245, 87, 108, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
            box-shadow: 0 4px 15px rgba(250, 112, 154, 0.4);
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 20px;
        }
        
        .input-group label {
            color: #fff;
            font-size: 12px;
            white-space: nowrap;
        }
        
        .input-group input {
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 15px;
            padding: 6px 12px;
            color: #fff;
            font-size: 14px;
            width: 80px;
        }
        
        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* è¿”å›æŒ‰é’® */
        .back-btn {
            position: fixed;
            top: 60px;
            left: 15px;
            z-index: 1001;
            padding: 10px 20px;
            background: rgba(0, 0, 0, 0.7);
            color: #fff;
            text-decoration: none;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .back-btn:hover {
            background: rgba(0, 0, 0, 0.9);
            transform: translateX(-3px);
        }
        
        /* Marker æç¤º */
        .marker-hint {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 999;
            background: rgba(0, 0, 0, 0.8);
            color: #fff;
            padding: 20px 30px;
            border-radius: 15px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            max-width: 300px;
        }
        
        .marker-hint.hidden {
            display: none;
        }
        
        .marker-hint h3 {
            margin-bottom: 10px;
            color: #FFD700;
        }
        
        .marker-hint p {
            font-size: 14px;
            line-height: 1.6;
        }
    </style>
</head>
<body>
    <!-- è¿”å›æŒ‰é’® -->
    <a href="index.html" class="back-btn">â† è¿”å›ä¸»é¡µ</a>
    
    <!-- çŠ¶æ€æ  -->
    <div class="status-bar">
        <div class="status-item">
            <div class="status-indicator" id="ws-status"></div>
            <span id="ws-text">WebSocket: è¿æ¥ä¸­...</span>
        </div>
        <div class="status-item">
            <div class="status-indicator" id="ar-status"></div>
            <span id="ar-text">AR.js: åˆå§‹åŒ–ä¸­...</span>
        </div>
        <div class="status-item">
            <div class="status-indicator" id="marker-status"></div>
            <span id="marker-text">Marker: ç­‰å¾…æ£€æµ‹...</span>
        </div>
        <div class="status-item">
            <span>FPS: <span id="fps">0</span></span>
        </div>
    </div>
    
    <!-- Marker æç¤º -->
    <div class="marker-hint" id="marker-hint">
        <h3>ğŸ“± å¯¹å‡† Marker</h3>
        <p>è¯·å°†æ‰‹æœºæ‘„åƒå¤´å¯¹å‡† Hiro Marker å›¾æ¡ˆ</p>
        <p style="margin-top: 10px; font-size: 12px; opacity: 0.8;">Marker å›¾æ¡ˆå¯ä»¥åœ¨ AR.js å®˜ç½‘ä¸‹è½½</p>
    </div>
    
    <!-- AR åœºæ™¯å®¹å™¨ -->
    <div id="ar-container">
        <a-scene 
            embedded 
            arjs="sourceType: webcam; sourceWidth: 1280; sourceHeight: 720; displayWidth: 1280; displayHeight: 720; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; cameraParametersUrl: https://cdn.jsdelivr.net/npm/ar.js@3.4.0/data/data/camera_para.dat; maxDetectionRate: 60; canvasWidth: 1280; canvasHeight: 720;"
            vr-mode-ui="enabled: false"
            renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true"
            gesture-detector>
            
            <!-- Marker -->
            <a-marker 
                type="pattern" 
                url="https://cdn.jsdelivr.net/npm/ar.js@3.4.0/data/data/hiro.patt"
                id="hiro-marker"
                smooth="true"
                smoothCount="10"
                smoothTolerance=".01"
                smoothThreshold="5">
                
                <!-- è§†è§‰åé¦ˆï¼šä¸€ä¸ªæ—‹è½¬çš„ç›’å­ -->
                <a-box 
                    position="0 0.5 0" 
                    rotation="0 45 0" 
                    color="#4CC3D9"
                    animation="property: rotation; to: 0 405 0; loop: true; dur: 4000">
                </a-box>
                
                <!-- åæ ‡è½´æŒ‡ç¤ºå™¨ -->
                <a-entity>
                    <a-entity 
                        geometry="primitive: cylinder; radius: 0.01; height: 0.3" 
                        material="color: #ff0000" 
                        position="0 0.15 0" 
                        rotation="90 0 0">
                    </a-entity>
                    <a-entity 
                        geometry="primitive: cylinder; radius: 0.01; height: 0.3" 
                        material="color: #00ff00" 
                        position="0.15 0 0" 
                        rotation="0 0 90">
                    </a-entity>
                    <a-entity 
                        geometry="primitive: cylinder; radius: 0.01; height: 0.3" 
                        material="color: #0000ff" 
                        position="0 0 0.15">
                    </a-entity>
                </a-entity>
            </a-marker>
            
            <!-- ç›¸æœº -->
            <a-camera gps-camera rotation-reader></a-camera>
        </a-scene>
    </div>
    
    <!-- æ•°æ®é¢æ¿ -->
    <div class="data-panel">
        <div class="data-grid">
            <div class="data-card">
                <h4>Position X</h4>
                <div class="data-value" id="pos-x">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
            <div class="data-card">
                <h4>Position Y</h4>
                <div class="data-value" id="pos-y">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
            <div class="data-card">
                <h4>Position Z</h4>
                <div class="data-value" id="pos-z">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
            <div class="data-card">
                <h4>Rotation X</h4>
                <div class="data-value" id="rot-x">0.000</div>
                <div class="data-unit">å››å…ƒæ•°</div>
            </div>
            <div class="data-card">
                <h4>Rotation Y</h4>
                <div class="data-value" id="rot-y">0.000</div>
                <div class="data-unit">å››å…ƒæ•°</div>
            </div>
            <div class="data-card">
                <h4>Rotation Z</h4>
                <div class="data-value" id="rot-z">0.000</div>
                <div class="data-unit">å››å…ƒæ•°</div>
            </div>
            <div class="data-card">
                <h4>Rotation W</h4>
                <div class="data-value" id="rot-w">1.000</div>
                <div class="data-unit">å››å…ƒæ•°</div>
            </div>
            <div class="data-card">
                <h4>Delta X</h4>
                <div class="data-value" id="delta-x">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
            <div class="data-card">
                <h4>Delta Y</h4>
                <div class="data-value" id="delta-y">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
            <div class="data-card">
                <h4>Delta Z</h4>
                <div class="data-value" id="delta-z">0.000</div>
                <div class="data-unit">ç±³</div>
            </div>
        </div>
        
        <div class="control-panel">
            <button class="btn btn-secondary" onclick="resetInitialPosition()">é‡ç½®åˆå§‹ä½ç½®</button>
            <button class="btn btn-danger" onclick="reconnectWebSocket()">é‡æ–°è¿æ¥ WebSocket</button>
            <div class="input-group">
                <label>ç¼©æ”¾:</label>
                <input type="number" id="scale-input" value="1.0" step="0.1" min="0.1" max="10" onchange="updateScale()">
            </div>
            <div class="input-group">
                <label>åç§» X:</label>
                <input type="number" id="offset-x" value="0" step="0.1" onchange="updateOffset()">
            </div>
            <div class="input-group">
                <label>åç§» Y:</label>
                <input type="number" id="offset-y" value="0" step="0.1" onchange="updateOffset()">
            </div>
            <div class="input-group">
                <label>åç§» Z:</label>
                <input type="number" id="offset-z" value="0" step="0.1" onchange="updateOffset()">
            </div>
        </div>
    </div>
    
    <script>
        // WebSocket è¿æ¥ç®¡ç†
        class GyroscopeWebSocket {
            constructor() {
                this.ws = null;
                this.isConnected = false;
                this.onConnectedCallback = null;
            }
            
            connect() {
                if (this.ws && (this.ws.readyState === WebSocket.OPEN || this.ws.readyState === WebSocket.CONNECTING)) {
                    console.log('â„¹ï¸ WebSocket å·²åœ¨é€£ç·šæˆ–é€£ç·šä¸­');
                    return;
                }
                
                const wsUrl = 'wss://testgyroscopehtml-production.up.railway.app';
                console.log('å˜—è©¦é€£æ¥WebSocket:', wsUrl);
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('âœ… WebSocketé€£æ¥å·²å»ºç«‹');
                    this.isConnected = true;
                    updateWSStatus(true);
                    try {
                        this.ws.send(JSON.stringify({ type: 'claim' }));
                    } catch (_) {}
                    if (this.onConnectedCallback) {
                        this.onConnectedCallback();
                    }
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.type === 'ack') {
                            console.log('âœ… æ•¸æ“šå·²æˆåŠŸç™¼é€');
                        }
                    } catch (error) {
                        console.error('è§£æWebSocketè¨Šæ¯éŒ¯èª¤:', error);
                    }
                };
                
                this.ws.onclose = (event) => {
                    console.log('âŒ WebSocketé€£æ¥å·²é—œé–‰:', event.code, event.reason);
                    this.isConnected = false;
                    updateWSStatus(false);
                };
                
                this.ws.onerror = (error) => {
                    console.error('âŒ WebSocketéŒ¯èª¤:', error);
                    updateWSStatus(false);
                };
            }
            
            sendPositionData(position, rotation, delta) {
                if (this.isConnected && this.ws && this.ws.readyState === WebSocket.OPEN) {
                    const data = {
                        type: 'position',
                        data: {
                            position: position,
                            rotation: rotation,
                            delta: delta,
                            timestamp: Date.now()
                        }
                    };
                    this.ws.send(JSON.stringify(data));
                }
            }
            
            setOnConnectedCallback(callback) {
                this.onConnectedCallback = callback;
            }
        }
        
        // AR.js Marker è¿½è¸ªå™¨
        class ARjsMarkerTracker {
            constructor(websocket) {
                this.ws = websocket;
                this.isTracking = false;
                this.lastPosition = null;
                this.initialPosition = null;
                this.markerFound = false;
                this.scene = null;
                this.camera = null;
                this.marker = null;
                this.scale = 1.0;
                this.offset = { x: 0, y: 0, z: 0 };
                this.frameCount = 0;
                this.lastFPSUpdate = Date.now();
            }
            
            init() {
                console.log('ğŸš€ åˆå§‹åŒ– AR.js Marker è¿½è¸ª...');
                updateARStatus('åˆå§‹åŒ–ä¸­...', false);
                
                // ç­‰å¾… A-Frame åŠ è½½å®Œæˆ
                if (typeof AFRAME === 'undefined') {
                    console.warn('âš ï¸ A-Frame å°šæœªè¼‰å…¥ï¼Œç­‰å¾…è¼‰å…¥...');
                    setTimeout(() => this.init(), 500);
                    return;
                }
                
                // ç­‰å¾…åœºæ™¯å…ƒç´ åˆ›å»º
                setTimeout(() => {
                    this.setupScene();
                    this.setupMarkerEvents();
                    this.startTracking();
                    updateARStatus('å·²å°±ç»ª', true);
                }, 1000);
            }
            
            setupScene() {
                this.scene = document.querySelector('a-scene');
                this.camera = document.querySelector('a-camera');
                this.marker = document.querySelector('a-marker');
                
                if (!this.scene || !this.camera || !this.marker) {
                    console.error('âŒ æ— æ³•æ‰¾åˆ° AR åœºæ™¯å…ƒç´ ');
                    updateARStatus('é”™è¯¯ï¼šåœºæ™¯å…ƒç´ æœªæ‰¾åˆ°', false);
                    return;
                }
                
                // ç­‰å¾…åœºæ™¯æ¸²æŸ“
                this.scene.addEventListener('renderstart', () => {
                    console.log('âœ… AR åœºæ™¯æ¸²æŸ“å·²å¯åŠ¨');
                });
            }
            
            setupMarkerEvents() {
                if (!this.marker) {
                    setTimeout(() => this.setupMarkerEvents(), 500);
                    return;
                }
                
                // ç›‘å¬ Marker è¢«å‘ç°
                this.marker.addEventListener('markerFound', () => {
                    console.log('âœ… Marker å·²æ£€æµ‹åˆ°');
                    this.markerFound = true;
                    this.isTracking = true;
                    updateMarkerStatus('å·²æ£€æµ‹', true);
                    document.getElementById('marker-hint').classList.add('hidden');
                    this.onMarkerFound();
                });
                
                // ç›‘å¬ Marker ä¸¢å¤±
                this.marker.addEventListener('markerLost', () => {
                    console.log('âš ï¸ Marker ä¸¢å¤±');
                    this.markerFound = false;
                    this.isTracking = false;
                    updateMarkerStatus('ç­‰å¾…æ£€æµ‹...', false);
                    document.getElementById('marker-hint').classList.remove('hidden');
                });
            }
            
            onMarkerFound() {
                if (this.initialPosition === null) {
                    const markerPose = this.getMarkerPose();
                    if (markerPose) {
                        this.initialPosition = { ...markerPose.position };
                        this.lastPosition = { ...markerPose.position };
                        console.log('ğŸ“ åˆå§‹ä½ç½®å·²è®°å½•:', this.initialPosition);
                    }
                }
            }
            
            startTracking() {
                const updateLoop = () => {
                    if (this.isTracking && this.markerFound) {
                        this.updatePosition();
                    }
                    this.updateFPS();
                    requestAnimationFrame(updateLoop);
                };
                updateLoop();
            }
            
            getMarkerPose() {
                if (!this.marker || !this.camera) return null;
                
                const markerObject = this.marker.object3D;
                const cameraObject = this.camera.object3D;
                
                if (!markerObject || !cameraObject) return null;
                
                // è·å– Marker çš„ä¸–ç•ŒçŸ©é˜µ
                const markerMatrix = new THREE.Matrix4();
                markerMatrix.copy(markerObject.matrixWorld);
                
                // è·å–ç›¸æœºå’Œ Marker çš„ä¸–ç•Œä½ç½®
                const cameraWorldPos = new THREE.Vector3();
                cameraObject.getWorldPosition(cameraWorldPos);
                
                const markerWorldPos = new THREE.Vector3();
                markerObject.getWorldPosition(markerWorldPos);
                
                // è®¡ç®—ç›¸å¯¹ä½ç½®ï¼ˆç›¸æœºä½ç½® - Markerä½ç½®ï¼‰
                const relativePosition = new THREE.Vector3();
                relativePosition.subVectors(cameraWorldPos, markerWorldPos);
                
                // å°†ä½ç½®è½¬æ¢åˆ° Marker çš„å±€éƒ¨åæ ‡ç³»
                const markerInverseMatrix = new THREE.Matrix4();
                markerInverseMatrix.copy(markerObject.matrixWorld).invert();
                relativePosition.applyMatrix4(markerInverseMatrix);
                
                // è·å–æ—‹è½¬ï¼ˆç›¸æœºç›¸å¯¹äº Markerï¼‰
                const cameraQuaternion = new THREE.Quaternion();
                cameraObject.getWorldQuaternion(cameraQuaternion);
                
                const markerQuaternion = new THREE.Quaternion();
                markerObject.getWorldQuaternion(markerQuaternion);
                
                // è®¡ç®—ç›¸å¯¹æ—‹è½¬
                const relativeQuaternion = new THREE.Quaternion();
                relativeQuaternion.copy(markerQuaternion).invert().multiply(cameraQuaternion);
                
                return {
                    position: {
                        x: (relativePosition.x * this.scale) + this.offset.x,
                        y: (relativePosition.y * this.scale) + this.offset.y,
                        z: (relativePosition.z * this.scale) + this.offset.z
                    },
                    rotation: {
                        x: relativeQuaternion.x,
                        y: relativeQuaternion.y,
                        z: relativeQuaternion.z,
                        w: relativeQuaternion.w
                    }
                };
            }
            
            updatePosition() {
                const pose = this.getMarkerPose();
                if (!pose) return;
                
                const position = pose.position;
                const rotation = pose.rotation;
                
                // è®¡ç®—ç›¸å¯¹ä½ç§»
                let delta = { x: 0, y: 0, z: 0 };
                
                if (this.initialPosition) {
                    delta = {
                        x: position.x - this.initialPosition.x,
                        y: position.y - this.initialPosition.y,
                        z: position.z - this.initialPosition.z
                    };
                }
                
                // æ›´æ–°æ˜¾ç¤º
                updateDataDisplay(position, rotation, delta);
                
                // é€šè¿‡ WebSocket å‘é€ä½ç½®æ•°æ®
                if (this.ws && this.ws.isConnected) {
                    this.ws.sendPositionData(position, rotation, delta);
                }
                
                this.lastPosition = { ...position };
            }
            
            updateFPS() {
                this.frameCount++;
                const now = Date.now();
                if (now - this.lastFPSUpdate >= 1000) {
                    const fps = this.frameCount;
                    this.frameCount = 0;
                    this.lastFPSUpdate = now;
                    document.getElementById('fps').textContent = fps;
                }
            }
            
            resetInitialPosition() {
                this.initialPosition = null;
                this.lastPosition = null;
                console.log('ğŸ”„ å·²é‡ç½®åˆå§‹ä½ç½®');
            }
            
            setScale(scale) {
                this.scale = parseFloat(scale) || 1.0;
                console.log(`ğŸ“ ç¼©æ”¾æ¯”ä¾‹å·²è®¾ç½®ä¸º: ${this.scale}`);
            }
            
            setOffset(x, y, z) {
                this.offset = {
                    x: parseFloat(x) || 0,
                    y: parseFloat(y) || 0,
                    z: parseFloat(z) || 0
                };
                console.log(`ğŸ“ åç§»é‡å·²è®¾ç½®ä¸º: (${this.offset.x}, ${this.offset.y}, ${this.offset.z})`);
            }
        }
        
        // å…¨å±€å˜é‡
        let gyroWS = null;
        let arTracker = null;
        
        // çŠ¶æ€æ›´æ–°å‡½æ•°
        function updateWSStatus(connected) {
            const indicator = document.getElementById('ws-status');
            const text = document.getElementById('ws-text');
            if (connected) {
                indicator.className = 'status-indicator connected';
                text.textContent = 'WebSocket: å·²è¿æ¥';
            } else {
                indicator.className = 'status-indicator error';
                text.textContent = 'WebSocket: æœªè¿æ¥';
            }
        }
        
        function updateARStatus(status, ready) {
            const indicator = document.getElementById('ar-status');
            const text = document.getElementById('ar-text');
            indicator.className = ready ? 'status-indicator connected' : 'status-indicator';
            text.textContent = `AR.js: ${status}`;
        }
        
        function updateMarkerStatus(status, tracking) {
            const indicator = document.getElementById('marker-status');
            const text = document.getElementById('marker-text');
            indicator.className = tracking ? 'status-indicator tracking' : 'status-indicator';
            text.textContent = `Marker: ${status}`;
        }
        
        function updateDataDisplay(position, rotation, delta) {
            document.getElementById('pos-x').textContent = position.x.toFixed(3);
            document.getElementById('pos-y').textContent = position.y.toFixed(3);
            document.getElementById('pos-z').textContent = position.z.toFixed(3);
            
            document.getElementById('rot-x').textContent = rotation.x.toFixed(3);
            document.getElementById('rot-y').textContent = rotation.y.toFixed(3);
            document.getElementById('rot-z').textContent = rotation.z.toFixed(3);
            document.getElementById('rot-w').textContent = rotation.w.toFixed(3);
            
            document.getElementById('delta-x').textContent = delta.x.toFixed(3);
            document.getElementById('delta-y').textContent = delta.y.toFixed(3);
            document.getElementById('delta-z').textContent = delta.z.toFixed(3);
        }
        
        // æ§åˆ¶å‡½æ•°
        function resetInitialPosition() {
            if (arTracker) {
                arTracker.resetInitialPosition();
            }
        }
        
        function reconnectWebSocket() {
            if (gyroWS) {
                gyroWS.connect();
            }
        }
        
        function updateScale() {
            const scale = document.getElementById('scale-input').value;
            if (arTracker) {
                arTracker.setScale(scale);
            }
        }
        
        function updateOffset() {
            const x = document.getElementById('offset-x').value;
            const y = document.getElementById('offset-y').value;
            const z = document.getElementById('offset-z').value;
            if (arTracker) {
                arTracker.setOffset(x, y, z);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            // åˆå§‹åŒ– WebSocket
            gyroWS = new GyroscopeWebSocket();
            gyroWS.connect();
            
            // ç­‰å¾… WebSocket è¿æ¥ååˆå§‹åŒ– AR.js
            gyroWS.setOnConnectedCallback(() => {
                setTimeout(() => {
                    // åˆå§‹åŒ– AR.js è¿½è¸ªå™¨
                    arTracker = new ARjsMarkerTracker(gyroWS);
                    arTracker.init();
                }, 500);
            });
            
            // å¦‚æœ WebSocket å·²ç»è¿æ¥ï¼Œç›´æ¥åˆå§‹åŒ– AR.js
            if (gyroWS.isConnected) {
                setTimeout(() => {
                    arTracker = new ARjsMarkerTracker(gyroWS);
                    arTracker.init();
                }, 500);
            }
        });
    </script>
</body>
</html>

